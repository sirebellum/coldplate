<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2D Cluster Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        #hover-image {
            position: absolute;
            max-width: 400px;
            max-height: 400px;
            display: none;
            border: 1px solid #ccc;
            pointer-events: none;
            z-index: 1000;
        }
        body {
            margin: 0;
            overflow: hidden;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2000;
        }
        #controls button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="clear-button">Clear</button>
        <button id="train-button">Train</button>
    </div>
    <div id="visualization" style="width: 100%; height: 100vh;"></div>
    <img id="hover-image" src="" alt="Hovered Image">
    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        let isHovering = false;
        const hoverImage = document.getElementById('hover-image');
        const visualizationDiv = document.getElementById('visualization');
        
        // Initialize Plotly with empty data
        const initialData = [{
            x: [],
            y: [],
            mode: 'markers',
            marker: { size: 5, opacity: 0.8, color: [] },
            customdata: []
        }];
        const layout = {
            title: '2D Cluster Visualization of IR Images',
            xaxis: { title: 'PC 1' },
            yaxis: { title: 'PC 2' }
        };
        
        Plotly.newPlot('visualization', initialData, layout);

        // Listen for graph updates
        socket.on('update_graph', function(graphJSON) {
            console.log("Received graph data:", graphJSON);
            const plotData = JSON.parse(graphJSON);
            Plotly.react('visualization', plotData.data, plotData.layout);
        });

        // Hover handlers
        visualizationDiv.on('plotly_hover', function(data){
            const pointData = data.points[0];
            const imageUrl = pointData.customdata;

            if(imageUrl){
                hoverImage.src = imageUrl;
                hoverImage.style.display = 'block';
                isHovering = true;
            }
        });

        visualizationDiv.on('plotly_unhover', function(data){
            hoverImage.style.display = 'none';
            isHovering = false;
        });

        visualizationDiv.addEventListener('mousemove', function(event){
            if(isHovering){
                hoverImage.style.left = (event.clientX + 15) + 'px';
                hoverImage.style.top = (event.clientY + 15) + 'px';
            }
        });

        // Add functionality for Clear button
        document.getElementById('clear-button').addEventListener('click', () => {
            console.log("Clear button clicked.");
            socket.emit('clear_graph');
        });

        // Add functionality for Train button
        document.getElementById('train-button').addEventListener('click', () => {
            console.log("Train button clicked.");
            socket.emit('train_model');
        });

        // Periodically update the graph
        setInterval(() => {
            socket.emit('update_graph');
        }, 10000);
    </script>
</body>
</html>
